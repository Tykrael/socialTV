/*!
   * massrel/stream-js 0.9.9
   *
   * Copyright 2012 Mass Relevance
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this work except in compliance with the License.
   * You may obtain a copy of the License at:
   *
   *    http://www.apache.org/licenses/LICENSE-2.0
   */
(function(){var a,b,c;(function(d){function j(a,b){if(a&&a.charAt(0)==="."&&b){b=b.split("/"),b=b.slice(0,b.length-1),a=b.concat(a.split("/"));var c,d;for(c=0;d=a[c];c++)if(d===".")a.splice(c,1),c-=1;else if(d==="..")if(c!==1||a[2]!==".."&&a[0]!=="..")c>0&&(a.splice(c-1,2),c-=2);else break;a=a.join("/")}return a}function k(a,b){return function(){return i.apply(d,g.call(arguments,0).concat([a,b]))}}function l(a){return function(b){return j(b,a)}}function m(a){return function(b){e[a]=b}}function n(a){if(f.hasOwnProperty(a)){var b=f[a];delete f[a],h.apply(d,b)}return e[a]}function o(a,b){var c,d,e=a.indexOf("!");return e!==-1?(c=j(a.slice(0,e),b),a=a.slice(e+1),d=n(c),d&&d.normalize?a=d.normalize(a,l(b)):a=j(a,b)):a=j(a,b),{f:c?c+"!"+a:a,n:a,p:d}}var e={},f={},g=[].slice,h,i;if(typeof c=="function")return;h=function(a,b,c,g){var h=[],i,j,l,p,q,r;g||(g=a);if(typeof c=="function"){!b.length&&c.length&&(b=["require","exports","module"]);for(p=0;p<b.length;p++){r=o(b[p],g),l=r.f;if(l==="require")h[p]=k(a);else if(l==="exports")h[p]=e[a]={},i=!0;else if(l==="module")j=h[p]={id:a,uri:"",exports:e[a]};else if(e.hasOwnProperty(l)||f.hasOwnProperty(l))h[p]=n(l);else if(r.p)r.p.load(r.n,k(g,!0),m(l),{}),h[p]=e[l];else throw a+" missing "+l}q=c.apply(e[a],h),a&&(j&&j.exports!==d?e[a]=j.exports:i||(e[a]=q))}else a&&(e[a]=c)},a=i=function(a,b,c,e){return typeof a=="string"?n(o(a,b).f):(a.splice||(b.splice?(a=b,b=arguments[2]):a=[]),e?h(d,a,b,c):setTimeout(function(){h(d,a,b,c)},15),i)},i.config=function(){return i},b||(b=i),c=function(a,b,d){b.splice||(d=b,b=[]),c.unordered?f[a]=[a,b,d]:h(a,b,d)},c.amd={jQuery:!0}})(),c("almond.js",function(){}),c("globals",{host:"tweetriver.com",timeout:1e4,protocol:document.location.protocol==="https:"?"https":"http",min_poll_interval:5e3,jsonp_param:"jsonp"}),c("helpers",["globals"],function(a){var b={},c=encodeURIComponent;b.step_through=function(a,c,d){a=b.is_array(a)?a:[a];var e=a.length-1;if(e>=0)for(;e>=0;e--){var f=a[e];for(var g=0,h=c.length;g<h;g++)c[g].call(d,f)}},b.extend=function(a,b){var c;for(c in b)typeof a[c]=="undefined"&&(a[c]=b[c]);return a},b.api_url=function(b,c){return c=c||a.host,a.protocol+"://"+c+b};var d=0;a._json_callbacks={},b.jsonp_factory=function(c,e,f,g,h,i){var j=f+ ++d,k=!1,l;a._json_callbacks[j]=function(c){typeof h=="function"?h(c):b.is_array(h)&&h.length>0&&helpers.step_through(c,h,g),delete a._json_callbacks[j],k=!0,clearTimeout(l)},e.push([a.jsonp_param,"massrel._json_callbacks."+j]);var m=b.load(c+"?"+b.to_qs(e));l=setTimeout(function(){k||(a._json_callbacks[j]=function(){delete a._json_callbacks[j]},typeof i=="function"&&i(),m.stop())},a.timeout)},b.is_array=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"};var e=document.getElementsByTagName("head")[0]||document.body;b.load=function(a,b){var c=document.createElement("script");c.type="text/javascript",c.src=a;var d=!1;return c.onload=c.onreadystatechange=function(){!d&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")&&(d=!0,c.onload=c.onreadystatechange=null,e&&c.parentNode&&e.removeChild(c),typeof b=="function"&&b())},e.insertBefore(c,e.firstChild),{stop:function(){c.onload=c.onreadystatechange=null,e&&c.parentNode&&e.removeChild(c),c.src="#"}}},b.to_qs=function(a){var d=[],e;if(a&&a.length){for(var f=0,g=a.length;f<g;f++){e=a[f][1];if(b.is_array(e)){for(var h=0,i=e.length;h<i;h++)e[h]=c(e[h]||"");e=e.join(",")}else e!==undefined&&e!==null?e=c(e):e="";d.push(c(a[f][0])+"="+e)}return d.join("&")}return""};var f=/\+\d{4} \d{4}$/,g=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(\+\d{4})$/;return b.fix_date=b.fix_twitter_date=function(a){if(f.test(a)){a=a.split(" ");var b=a.pop();a.splice(3,0,b),a=a.join(" ")}else g.test(a)&&(a=a.replace(g,"$1/$2/$3 $4:$5:$6 $7"));return a},b.parse_params=function(){raw={},queryString=window.location.search.substring(1),queryString.charAt(0)=="?"&&(queryString=queryString.substring(1));if(queryString.length>0){queryString=queryString.replace(/\+/g," ");var a=queryString.split(/[&;]/g);for(var b=0;b<a.length;b++){var c=a[b].split("="),d=decodeURIComponent(c[0]),e=c.length>1?decodeURIComponent(c[1]):"";if(d in raw){var f=raw[d];typeof f!="string"?raw[d].push(e):(raw[d]=[],raw[d].push(f),raw[d].push(e))}else raw[d]=e}}return raw},b.poll_interval=function(b){var c=a.min_poll_interval;return Math.max(b||c,c)},b}),c("meta_poller",["helpers"],function(a){function b(b,c){var d=this,e=function(){g&&b.meta(d.opts,function(b){g&&(a.step_through(b,d._listeners,d),g&&f())},function(){f()})},f=function(){h=setTimeout(e,a.poll_interval(d.opts.frequency))},g=!1,h;this._listeners=[],this.opts=c||{},this.opts.frequency=(this.opts.frequency||30)*1e3,this.start=function(){return g||(g=!0,e()),this},this.stop=function(){return clearTimeout(h),g=!1,this}}return b.prototype.data=function(a){return this._listeners.push(a),this},b.prototype.each=b.prototype.data,b}),c("account",["helpers","meta_poller"],function(a,b){function d(a){this.user=a}var c=encodeURIComponent;return d.prototype.meta_url=function(){return a.api_url("/"+c(this.user)+".json")},d.prototype.meta=function(){var b,c,d;if(typeof arguments[0]=="function")c=arguments[0],d=arguments[1],b={};else if(typeof arguments[0]=="object")b=arguments[0],c=arguments[1],d=arguments[2];else throw new Error("incorrect arguments");var e=this.buildMetaParams(b);return a.jsonp_factory(this.meta_url(),e,"meta_",this,c,d),this},d.prototype.buildMetaParams=function(b){b=b||{};var c=[];b.quick_stats&&c.push(["quick_stats","1"]);if(b.streams){var d=a.is_array(b.streams)?b.streams:[b.streams];c.push(["streams",d.join(",")])}return c},d.prototype.metaPoller=function(a){return new b(this,a)},d.prototype.toString=function(){return this.user},d}),c("poller_queue",["helpers"],function(a){function b(b,c){function k(){i=j.total,setTimeout(function(){if(j.poller.enabled&&j.total===i&&e.length>0&&d.length===0){var a=Math.min(Math.floor(e.length*Math.random()),e.length-1),b=e[a];d.push(b),j.total+=1,j.enqueued+=1,j.reused+=1,l()}k()},c.history_timeout*1e3)}function l(){if(!g&&d.length>0&&typeof f=="function"){var a=++h;j.enqueued-=1,j.count+=1;var b=d.shift();g=!0,f.call(j,b,function(){a===h&&(g=!1,setTimeout(l,0))}),c.history_size>0&&!b.__recycled&&(c.history_size===e.length&&e.shift(),b.__recycled=!0,e.push(b))}}this.poller=b,c=a.extend(c||{},{history_size:0,history_timeout:b.frequency/1e3});var d=[],e=[],f=null,g=!1,h=0,i=0;this.total=0,this.enqueued=0,this.count=0,this.reused=0;var j=this;b.batch(function(a){var b=a.length,c=b-1;for(;c>=0;c--)d.push(a[c]);j.total+=b,j.enqueued+=b,l()}),c.history_size>0&&k(),this.next=function(a){!g&&typeof a=="function"&&(f=a,l())}}return b}),c("poller",["helpers","poller_queue"],function(a,b){function c(a,b){this.stream=a,this._callbacks=[],this._enumerators=[],this._bound_enum=!1,this._t=null,b=b||{},this.limit=b.limit||null,this.since_id=b.since_id||null,this.start_id=b.start_id||null,this.replies=!!b.replies,this.geo_hint=!!b.geo_hint,this.keywords=b.keywords||null,this.frequency=(b.frequency||30)*1e3,this.stay_realtime="stay_realtime"in b?!!b.stay_realtime:!0,this.enabled=!1,this.alive=!0,this.alive_instance=0,this.consecutive_errors=0}return c.prototype.poke=function(a){return!this.alive&&this.enabled&&(this._t=null,this.start()),this},c.prototype.batch=function(a){return this._callbacks.push(a),this},c.prototype.each=function(a){return this._enumerators.push(a),this},c.prototype.start=function(){function d(){c.alive=!1;if(!c.enabled||b!==c.alive_instance)return;var e={};c.stay_realtime?e.since_id=c.since_id:e.from_id=c.since_id,c.stream.load(c.params(e),function(b){c.alive=!0,c.consecutive_errors=0;if(b&&b.length>0){c.since_id=b[0].entity_id,c.start_id||(c.start_id=b[b.length-1].entity_id);for(var e=0,f=c._callbacks.length;e<f;e++)c._callbacks[e].call(c,b);a.step_through(b,c._enumerators,c)}c._t=setTimeout(d,a.poll_interval(c.frequency))},function(){c.consecutive_errors+=1,c.poke()})}if(this._t)return this;this.enabled=!0;var b=this.alive_instance=this.alive_instance+1,c=this;return d(),this},c.prototype.stop=function(){return clearTimeout(this._t),this._t=null,this.enabled=!1,this},c.prototype.queue=function(a){var c=new b(this);return c.next(a),this},c.prototype.more=function(a,b){var c=this,d=function(){c.stream.load(c.params({start_id:c.start_id}),function(b){b.length>0&&(c.start_id=b[b.length-1].entity_id,c.since_id||(c.since_id=b[0].entity_id)),a.call(c,b)},function(){typeof b=="function"&&b()})};return d(),this},c.prototype.params=function(b){return a.extend({limit:this.limit,replies:this.replies,geo_hint:this.geo_hint,keywords:this.keywords},b||{})},c}),c("stream",["helpers","poller","meta_poller"],function(a,b,c){function e(){var a=arguments.length===1?arguments[0].split("/"):arguments;this.account=a[0],this.stream_name=a[1],this._enumerators=[]}var d=encodeURIComponent;return e.prototype.stream_url=function(){return a.api_url("/"+d(this.account)+"/"+d(this.stream_name)+".json")},e.prototype.meta_url=function(){return a.api_url("/"+d(this.account)+"/"+d(this.stream_name)+"/meta.json")},e.prototype.load=function(b,c,d){b=a.extend(b||{},{});var e=this.buildParams(b);return a.jsonp_factory(this.stream_url(),e,"_",this,c||this._enumerators,d),this},e.prototype.buildParams=function(a){a=a||{};var b=[];return a.limit&&b.push(["limit",a.limit]),a.since_id?b.push(["since_id",a.since_id]):a.from_id?b.push(["from_id",a.from_id]):(a.start_id||a.start)&&b.push(["start",a.start_id||a.start]),a.replies&&b.push(["replies","1"]),a.geo_hint&&b.push(["geo_hint","1"]),a.keywords&&b.push(["keywords",a.keywords]),b},e.prototype.each=function(a){return this._enumerators.push(a),this},e.prototype.poller=function(a){return new b(this,a)},e.prototype.meta=function(){var b,c,d;if(typeof arguments[0]=="function")c=arguments[0],d=arguments[1],b={};else if(typeof arguments[0]=="object")b=arguments[0],c=arguments[1],d=arguments[2];else throw new Error("incorrect arguments");var e=this.buildMetaParams(b);return a.jsonp_factory(this.meta_url(),e,"meta_",this,c,d),this},e.prototype.buildMetaParams=function(a){a=a||{};var b=[];return a.disregard&&b.push(["disregard",a.disregard]),a.num_minutes&&b.push(["num_minutes",a.num_minutes]),a.num_hours&&b.push(["num_hours",a.num_hours]),a.num_days&&b.push(["num_days",a.num_days]),a.top_periods&&b.push(["top_periods",a.top_periods]),a.top_periods_relative&&b.push(["top_periods_relative",a.top_periods_relative]),a.finish&&b.push(["finish",a.finish]),b},e.prototype.metaPoller=function(a){return new c(this,a)},e}),c("context",["helpers"],function(a){function b(a){this.status=a,this.source={facebook:!1,twitter:!1,message:!1},this.known=!1,this.intents=!0}return b.create=function(c,d){c=c||{};var e=new b(c);return d=a.extend(d||{},{intents:!0,retweeted_by:!0}),e.intents=d.intents,c.id_str&&c.text&&c.entities&&(e.source.twitter=e.known=!0),c.facebook_id?(e.source.facebook=!0,e.known=typeof c.message=="string"):c.network==="massrelevance"&&(e.source.message=e.known=!0),e.source.twitter&&c.retweeted_status&&d.retweeted_by&&(e.retweet=!0,e.retweeted_by_user=c.user,e.status=c.retweeted_status),e},b}),c("intents",["helpers"],function(a){var b={base_url:"https://twitter.com/intent/",params:{text:"(string): default text, for tweet/reply",url:"(string): prefill url, for tweet/reply",hashtags:"(string): hashtag (or list with ,) without #, for tweet/reply",related:"(string): screen name (or list with ,) without @, available for all",in_reply_to:"(number): tweet id, only for reply",via:"(string): screen name without @, tweet/reply",tweet_id:"(number): tweet id, for retweet and favorite",screen_name:"(string): only for user/profile",user_id:"(number): only for user/profile"}};return b.url=function(c,d){d=d||{};var e=[];for(var f in d)e.push([f,d[f]]);return b.base_url+encodeURIComponent(c)+"?"+a.to_qs(e)},b.tweet=function(a){return b.url("tweet",a)},b.reply=function(a,c){return c=c||{},c.in_reply_to=a,b.tweet(c)},b.retweet=function(a,c){return c=c||{},c.tweet_id=a,b.url("retweet",c)},b.favorite=function(a,c){return c=c||{},c.tweet_id=a,b.url("favorite",c)},b.user=function(a,c){return c=c||{},isNaN(parseInt(a,10))?c.screen_name=a:c.user_id=a,b.url("user",c)},b.profile=b.user,b}),c("massrel",["globals","helpers","stream","account","poller","meta_poller","poller_queue","context","intents"],function(d,e,f,g,h,i,j,k,l){var m=window.massrel;typeof m=="undefined"?m=window.massrel=d:e.extend(m,d),m.Stream=f,m.Account=g,m.Poller=h,m.MetaPoller=i,m.PollerQueue=j,m.Context=k,m.helpers=e,m.intents=l,m.define=c,m.require=b,m.requirejs=a,typeof window.define=="function"&&typeof window.define.amd!="undefined"&&window.define(m)})})()
